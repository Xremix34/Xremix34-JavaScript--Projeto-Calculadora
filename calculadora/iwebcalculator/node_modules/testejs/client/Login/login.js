/**
 * Created by Administrator on 2016/11/10.
 */
var common = require("../../webconfig/common");
var apiUrl = require("../../webconfig/ApiUrl");
var Client = require('node-rest-client').Client;
var client = new Client();
var args = { headers: { "Content-Type": "application/json" } };
var MD5 = require("../../extends/helper/MD5");

var userInfo = require("../../model/user/user");

var jsonWrite = function(res, ret) {
    if (typeof ret === "undefined") {
        res.json({
            code: "1",
            msg: "操作失败"
        });
    } else {
        res.json(ret);
    }
};
module.exports = {
    login: function(req, res, next) {
        var con = ["Name=" + req.body.name, "Pwd=" + req.body.pwd, "CustKey=" + common.keyCode, "KeyCode=" + common.keyCode];
        var data = { Name: req.body.name, pwd: req.body.pwd, CustKey: common.keyCode, SecCode: MD5.MD5(con.sort().join("&")) };
        args.data = data;
        client.post(common.APICRMCenter + apiUrl.LoginUrl, args, function(data, response) {
            if (data.BusinessStatus == 1) {
                req.session.user = userInfo.userInfo(data);
                req.session.agentName = data.name;
                req.session.module = data.module;
                jsonWrite(res, { BusinessStatus: data.BusinessStatus, StatusMessage: data.StatusMessage });
            } else {
                jsonWrite(res, { BusinessStatus: data.BusinessStatus, StatusMessage: data.StatusMessage });
            }
        });
    }
};